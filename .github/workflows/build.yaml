name: AKB K50 内核构建
on:
  push:
    branches:
      - main
  workflow_dispatch:
    # 允许手动触发构建

jobs:
  Build:
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout
        uses: actions/checkout@master

      - name: Check System
        run: |
          ./build_script.sh check_system

      - name: Install deps
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            libssl-dev \
            flex \
            bison \
            libfl-dev \
            bc \
            xsltproc \
            libxml2-utils \
            device-tree-compiler \
            make \
            python3 \
            ccache \
            git \
            libarchive-tools \
            tar \
            gzip \
            bzip2 \
            unzip \
            wget \
            zlib1g-dev \
            automake \
            pkg-config \
            libgmp-dev \
            libmpc-dev \
            libmpfr-dev \
            libncurses-dev

      - name: Prepare
        run: |
          chmod +x build_script.sh
          ./build_script.sh prepare

      - name: Build
        run: |
          ./build_script.sh build

      - name: Packup
        run: |
          ./build_script.sh packup

      - name: Upload kernel artifacts
        uses: actions/upload-artifact@v4
        with:
          name: "kernel.zip"
          path: artifacts/kernel/*

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: "AK3-flash.zip"
          path: artifacts/AnyKernel3/*

      - name: Upload full log
        if: success() || failure()
        uses: actions/upload-artifact@v4
        with:
          name: "full-log"
          path: full.log
