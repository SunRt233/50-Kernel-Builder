name: AKB K50 ÂÜÖÊ†∏ÊûÑÂª∫
on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout
        uses:
          actions/checkout@master

          # üëá Êñ∞Â¢ûÔºöÁ≥ªÁªü‰ø°ÊÅØËæìÂá∫ÔºàÁÆÄÊ¥ÅÁæéËßÇÔºâ
      - name: System Info
        run: |
          echo "üñ•Ô∏è  System Configuration"
          echo "----------------------------"
          CPU_MODEL=$(lscpu | awk -F: '/Model name/ && /CPU/ {gsub(/^ +| *$/,"",$2); print substr($2,1,40)}')
          echo "CPU   : $(nproc) cores ($CPU_MODEL)"

          eval $(free -h | awk '/^Mem:/ {printf "TOTAL=%s;AVAIL=%s;USED=%s",$2,$7,$3}')
          echo "Memory: ${TOTAL:-?} RAM (Available: ${AVAIL:-?})"

          eval $(df -h / | awk 'NR==2 {printf "TOTAL=%s;USED=%s;FREE=%s;USE=%s",$2,$3,$4,$5}')
          echo "Disk  : ${USED:-?} used out of ${TOTAL:-?} (${USE:-?} used)"

          OS_NAME=$(awk -F= '/^PRETTY_NAME/{gsub(/"/,"",$2);print $2}' /etc/os-release)
          echo "OS    : $OS_NAME"

      - name: Install deps
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            libssl-dev \
            flex \
            bison \
            libfl-dev \
            bc \
            xsltproc \
            libxml2-utils \
            device-tree-compiler \
            make \
            python3 \
            ccache \
            git \
            libarchive-tools \
            tar \
            gzip \
            bzip2 \
            unzip \
            wget \
            zlib1g-dev \
            automake \
            pkg-config \
            libgmp-dev \
            libmpc-dev \
            libmpfr-dev \
            libncurses-dev

      - name: Prepare
        run: |
          chmod +x build_script.sh
          (. ./build_script.sh ;prepare)

      - name: Build
        run: |
          (. ./build_script.sh ;main)

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: "output"
          path: out/*
